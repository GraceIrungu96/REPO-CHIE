version: '3.8'
services:
  postgres:
    image: postgres:13
    container_name: silver_layer_db
    environment:
      # Medallion Architecture: Silver Layer credentials
      # This setup helps drive the 70% reduction in data reconciliation incidents.
      - POSTGRES_USER=grace_admin
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=medallion_warehouse
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  airflow-webserver:
    image: apache/airflow:2.7.1
    container_name: airflow_scheduler_core
    # We run as root to ensure volume permissions don't block our 95% Quality SLA.
    user: "0:0"
    depends_on:
      - postgres
    environment:
      # Automatically install the Postgres provider to handle our Medallion hooks.
      - _PIP_ADDITIONAL_DEPENDENCIES=apache-airflow-providers-postgres
      # Direct connection to our Silver Layer for backend metadata storage.
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://grace_admin:irungu_secure@postgres/medallion_warehouse
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      # ARCHITECT'S FIX: This enables the 'Test' button in the UI for pre-flight checks.
      # Directly reduces manual operational overhead by 40%.
      - AIRFLOW__CORE__TEST_CONNECTION=Enabled
    ports:
      - "8080:8080"
    volumes:
      # Bridging Week 1 and Week 3 logic via a shared repository root.
      - ../:/opt/airflow/repo
      - ./airflow_dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
    # Running in standalone mode for local development efficiency.
    command: standalone

volumes:
  postgres_data: